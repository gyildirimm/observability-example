# **Observability Rehberi: Grafana, Loki, Tempo ve Prometheus**

## **ğŸ” OpenTelemetry Nedir?**

**OpenTelemetry (OTel)**, daÄŸÄ±tÄ±lmÄ±ÅŸ sistemlerde **telemetri verilerini (tracing, metrics, logs) toplamak** ve birden fazla backend sistemine gÃ¶ndermek iÃ§in kullanÄ±lan **aÃ§Ä±k kaynaklÄ± bir gÃ¶zlemlenebilirlik Ã§erÃ§evesidir**.  
Prometheus, Grafana Tempo, Jaeger ve diÄŸer sistemlerle entegrasyon saÄŸlar.  

### **ğŸš€ OpenTelemetry BileÅŸenleri**

1. **Tracing (Ä°zleme)**: Servisler arasÄ± isteklerin nasÄ±l ilerlediÄŸini takip eder.
2. **Metrics (Metrikler)**: UygulamanÄ±n performansÄ±nÄ± Ã¶lÃ§en zaman serisi verilerini toplar.
3. **Logging (Loglama)**: UygulamanÄ±n iÃ§indeki olaylarÄ± detaylÄ± olarak kaydeder.

---

## **ğŸ› OpenTelemetry Instrumentation'larÄ± Nelerdir?**

**Instrumentation**, uygulamalarÄ±n otomatik olarak telemetri verisi Ã¼retmesini saÄŸlayan **ara katman kÃ¼tÃ¼phaneleridir**.

### **ğŸ“Œ .NET Core'da OpenTelemetry Instrumentation'larÄ±**

| **Instrumentation** | **AÃ§Ä±klama** |
|----------------------|-------------|
| **AspNetCore** | HTTP isteklerini ve yanÄ±t sÃ¼relerini Ã¶lÃ§er. |
| **HttpClient** | API Ã§aÄŸrÄ±larÄ±nÄ± ve istek sÃ¼relerini izler. |
| **EntityFrameworkCore** | VeritabanÄ± sorgularÄ±nÄ± takip eder. |
| **System.Runtime** | Bellek, Ã§Ã¶p toplama (GC) ve CPU kullanÄ±m verilerini toplar. |
| **System.Diagnostics.Metrics** | Ã–zel metrikler tanÄ±mlamak iÃ§in kullanÄ±lÄ±r. |

### **ğŸ“Œ .NET Core OpenTelemetry KullanÄ±mÄ±**

```csharp
// OpenTelemetry yapÄ±landÄ±rmasÄ±
        builder.Services.AddOpenTelemetry()
        .WithTracing(tracerProvider =>
        {
            tracerProvider
                .AddSource(activitySource.Name)
                .SetResourceBuilder(ResourceBuilder.CreateDefault()
                    .AddService("ExampleWebAPI")
                    .AddTelemetrySdk()
                    .AddEnvironmentVariableDetector())
                .AddAspNetCoreInstrumentation(options =>
                {
                    options.Filter = null; // TÃ¼m istekleri kaydet

                    options.RecordException = true;
                })
                .AddHttpClientInstrumentation(options =>
                {
                    options.RecordException = true;
                })
                .AddConsoleExporter()
                .AddOtlpExporter(opts =>
                {
                    opts.Endpoint = new Uri("http://observability-tempo:4317"); // Tempo OTLP gRPC endpoint
                    opts.Protocol = OtlpExportProtocol.Grpc; // GRPC protokolÃ¼nÃ¼ kullan
                });
        })
        .WithMetrics(metrics =>
        {
            metrics
                .SetResourceBuilder(ResourceBuilder.CreateDefault().AddService("MyMetricService"))
                .AddAspNetCoreInstrumentation() // HTTP request metrikleri
                .AddHttpClientInstrumentation() // HTTP client metrikleri
                .AddProcessInstrumentation() // Ä°ÅŸlem bazlÄ± metrikler (CPU, memory)
                .AddRuntimeInstrumentation() // .NET runtime metrikleri
                .AddMeter("System.Runtime") // .NET Runtime metrikleri iÃ§in gerekli.. // GC sÃ¼resi, bellek kullanÄ±mÄ±, CPU yÃ¼kÃ¼
                .AddMeter("System.Threading") // Thread havuzu metrikleri
                .AddMeter("Custom.Http.Meter")
                .AddEventCountersInstrumentation(options =>
                {
                    // HTTP istek ve baÄŸlantÄ± metrikleri
                    options.AddEventSources("System.Net.Http"); // HTTP istemci istek sayÄ±sÄ±
                    options.AddEventSources("System.Net.Sockets"); // TCP baÄŸlantÄ±larÄ±
                    options.AddEventSources("System.Net.NameResolution"); // DNS istekleri
                    
                    // ASP.NET Core metrikleri
                    options.AddEventSources("Microsoft.AspNetCore.Hosting"); // Request sÃ¼releri
                    options.AddEventSources("Microsoft.AspNetCore.Http.Connections"); // WebSocket ve SignalR metrikleri
                })
                .AddConsoleExporter() // Konsola yazdÄ±rma
                .AddPrometheusExporter(); // Prometheus exporter'Ä± ekle
        });
```

ğŸ‘‰ **Bu ayarlar sayesinde OpenTelemetry, uygulamanÄ±n tracing, metrik ve loglarÄ±nÄ± otomatik olarak toplayarak uygun backend sistemlerine (Tempo, Prometheus, Loki) aktarÄ±r.**

---

## **1ï¸âƒ£ Grafana Nedir?**

**Grafana**, metrikleri, loglarÄ± ve izleme verilerini gÃ¶rselleÅŸtirmek iÃ§in kullanÄ±lan bir aÃ§Ä±k kaynaklÄ± izleme platformudur.  
Verileri **Prometheus, Loki, Tempo gibi sistemlerden Ã§eker** ve bunlarÄ± **dashboardâ€™lar ile sunar**.

### **ğŸ“Œ Docker Compose ile Grafana NasÄ±l Eklenir?**

```yaml
services:
  observability-grafana:
    image: grafana/grafana:latest
    container_name: observability-grafana
    ports:
      - "9190:3000" # 3000 dÄ±ÅŸ port yerine 9190 kullanÄ±ldÄ±
    networks:
      - observability-example-network
    volumes:
      - .deploy/grafana:/var/lib/grafana
      - .deploy/grafana/provisioning:/etc/grafana/provisioning
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_AUTH_ANONYMOUS_ENABLED=true
```

ğŸ‘‰ **Grafanaâ€™yÄ± `http://localhost:9190` Ã¼zerinden aÃ§abilirsin.**  

![Observability Overview](./docs/net-core-dashboard.png)

---

## **2ï¸âƒ£ Loki Nedir?**

**Loki**, merkezi bir log yÃ¶netim sistemidir. **Promtail ile loglarÄ± toplayÄ±p Grafana Ã¼zerinden gÃ¶rselleÅŸtirmeye olanak tanÄ±r.**  
Grafana Lokiâ€™yi kullanarak sistem loglarÄ±nÄ± analiz edebiliriz.

![Observability Overview](./docs/loki-logs.png)

### **ğŸ“Œ Docker Compose ile Loki NasÄ±l Eklenir?**

```yaml
services:
  observability-loki:
    image: grafana/loki:latest
    container_name: observability-loki
    ports:
      - "9182:3100"
    networks:
      - observability-example-network
    volumes:
      - .deploy/loki:/loki
      - .deploy/loki/loki-config.yaml:/etc/loki/local-config.yaml
```

ğŸ‘‰ **Lokiâ€™ye Promtail veya Fluentd gibi log toplayÄ±cÄ±larÄ± baÄŸlamalÄ±sÄ±n.**

### **ğŸ“Œ Loki `Program.cs` ve `appsettings.json` KonfigÃ¼rasyonu**

#### **appsettings.json**

```json
"Serilog": {
  "Using": [ "Serilog.Sinks.Console", "Serilog.Sinks.Loki" ],
  "MinimumLevel": "Information",
  "WriteTo": [
      {
        "Name": "GrafanaLoki",
        "Args": {
          "uri": "http://observability-loki:3100",
          "labels": [
            {
              "key": "app",
              "value": "ExampleWebAPI"
            },
            {
              "key": "environment",
              "value": "development"
            }
          ],
          "propertiesAsLabels": ["RequestId", "RequestPath"]
        }
      }
  ]
}
```

#### **Program.cs**

```csharp
        builder.Host.UseSerilog((context, loggerConfig) => loggerConfig.ReadFrom.Configuration(context.Configuration));


        // OpenTelemetry Logging (Uygulama loglarÄ±nÄ± OpenTelemetry ile entegre eder)
        builder.Logging.AddOpenTelemetry(options =>
        {
            // Log scope'larÄ±nÄ± (kapsamlarÄ±nÄ±) dahil eder. 
            // Ã–rneÄŸin, bir request sÄ±rasÄ±nda oluÅŸturulan kapsamlÄ± loglarÄ± takip etmeye yarar.
            options.IncludeScopes = true;

            // Log mesajlarÄ±nÄ±n iÅŸlenmiÅŸ (formatlanmÄ±ÅŸ) halini dahil eder.
            // Ã–rneÄŸin, iÃ§inde deÄŸiÅŸkenler olan bir log mesajÄ±nÄ± doÄŸrudan kaydetmeyi saÄŸlar.
            options.IncludeFormattedMessage = true;

            // Log state'lerini ayrÄ±ÅŸtÄ±rarak (parse ederek) OpenTelemetry'de kullanÄ±labilir hale getirir.
            // Ã–rneÄŸin, structured logging formatÄ±nda loglarÄ± iÅŸlemeye yardÄ±mcÄ± olur.
            options.ParseStateValues = true;
        });
```

---

## **3ï¸âƒ£ Tempo Nedir?**

**Tempo**, daÄŸÄ±tÄ±lmÄ±ÅŸ izleme (tracing) iÃ§in kullanÄ±lan bir sistemdir.  
**OpenTelemetry, Jaeger ve Zipkin gibi sistemlerden gelen tracing verilerini saklar ve analiz eder.**

![Observability Overview](./docs/tempo-tracing.png)

### **ğŸ“Œ Docker Compose ile Tempo NasÄ±l Eklenir?**

```yaml
services:
  observability-tempo:
    image: grafana/tempo:latest
    container_name: observability-tempo
    ports:
      - "9184:3200"
      - "9186:9411"
    networks:
      - observability-example-network
    volumes:
      - .deploy/tempo:/tempo
      - .deploy/tempo/tempo-config.yaml:/etc/tempo.yaml
    expose:
      - "4317" # OTLP gRPC baÄŸlantÄ±sÄ± iÃ§in
      - "4318" # OTLP HTTP baÄŸlantÄ±sÄ± iÃ§in
```

ğŸ‘‰ **Tempoâ€™yu Grafana ile baÄŸlayarak tracing verilerini gÃ¶rselleÅŸtirebilirsin.**

### **ğŸ“Œ Tempo `Program.cs` KonfigÃ¼rasyonu**

```csharp
builder.Services.AddOpenTelemetry()
    .WithTracing(tracing =>
    {
        tracing
            .AddSource(activitySource.Name)
            .SetResourceBuilder(ResourceBuilder.CreateDefault()
            .AddService("ExampleWebAPI")
            .AddTelemetrySdk()
            .AddEnvironmentVariableDetector())
            .AddAspNetCoreInstrumentation()
            .AddHttpClientInstrumentation()
            .AddConsoleExporter()
            .AddOtlpExporter(opts =>
            {
                opts.Endpoint = new Uri("http://observability-tempo:4317");
                opts.Protocol = OtlpExportProtocol.Grpc;
            });
    });
```

---

## **4ï¸âƒ£ Prometheus Nedir?**

**Prometheus**, metrikleri toplayan ve sorgulayan bir sistemdir.  
Grafana ile birlikte kullanÄ±larak **sistem performansÄ±nÄ± izlemek ve alarmlar oluÅŸturmak iÃ§in idealdir.**

![Observability Overview](./docs/prometheus-panel.png)

### **ğŸ“Œ Docker Compose ile Prometheus NasÄ±l Eklenir?**

```yaml
services:
  observability-prometheus:
    image: prom/prometheus:latest
    container_name: observability-prometheus
    ports:
      - "9188:9090"
    networks:
      - observability-example-network
    volumes:
      - .deploy/prometheus:/prometheus
      - .deploy/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
```

ğŸ‘‰ **Prometheus metriklerini gÃ¶rmek iÃ§in:** `http://localhost:9188`

### **ğŸ“Œ Prometheus `Program.cs` KonfigÃ¼rasyonu**

```csharp
builder.Services.AddOpenTelemetry()
    .WithMetrics(metrics =>
    {
        metrics
                .SetResourceBuilder(ResourceBuilder.CreateDefault().AddService("MyMetricService"))
                .AddAspNetCoreInstrumentation() // HTTP request metrikleri
                .AddHttpClientInstrumentation() // HTTP client metrikleri
                .AddProcessInstrumentation() // Ä°ÅŸlem bazlÄ± metrikler (CPU, memory)
                .AddRuntimeInstrumentation() // .NET runtime metrikleri
                .AddMeter("System.Runtime") // .NET Runtime metrikleri iÃ§in gerekli.. // GC sÃ¼resi, bellek kullanÄ±mÄ±, CPU yÃ¼kÃ¼
                .AddMeter("System.Threading") // Thread havuzu metrikleri
                .AddMeter("Custom.Http.Meter")
                .AddEventCountersInstrumentation(options =>
                {
                    // HTTP istek ve baÄŸlantÄ± metrikleri
                    options.AddEventSources("System.Net.Http"); // HTTP istemci istek sayÄ±sÄ±
                    options.AddEventSources("System.Net.Sockets"); // TCP baÄŸlantÄ±larÄ±
                    options.AddEventSources("System.Net.NameResolution"); // DNS istekleri
                    
                    // ASP.NET Core metrikleri
                    options.AddEventSources("Microsoft.AspNetCore.Hosting"); // Request sÃ¼releri
                    options.AddEventSources("Microsoft.AspNetCore.Http.Connections"); // WebSocket ve SignalR metrikleri
                })
                .AddConsoleExporter() // Konsola yazdÄ±rma
                .AddPrometheusExporter(); // Prometheus exporter'Ä± ekle
    });

app.UseOpenTelemetryPrometheusScrapingEndpoint();
```

---

## **ğŸ¯ SonuÃ§**

| **BileÅŸen**  | **AÃ§Ä±klama** | **BaÄŸlantÄ±** |
|--------------|-------------|-------------|
| **Grafana** | Verileri gÃ¶rselleÅŸtirir | `http://localhost:9190` |
| **Loki** | Log yÃ¶netim sistemi | `http://localhost:9182` |
| **Tempo** | Tracing (daÄŸÄ±tÄ±lmÄ±ÅŸ izleme) | `http://localhost:9184` |
| **Prometheus** | Metrik toplama ve analiz | `http://localhost:9188` |

ğŸš€ **Bu rehberi takip ederek Observability sistemini eksiksiz bir ÅŸekilde Docker Compose ve .NET Core ile Ã§alÄ±ÅŸtÄ±rabilirsin.**
